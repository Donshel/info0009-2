<!DOCTYPE html>

<html lang="fr">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Arti-clever</title>
		<meta name="author" content="Simon Bernard, Ivan Klapka, François Rozet">
		<link rel="icon" type="image/png" href="./resources/images/png/favicon.png">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">
		<link rel="stylesheet" href="./resources/css/default.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"></script>
	</head>
	<body>
		<section id="hero">
			<div class="container">
				<div class="title special">Arti-clever</div>
				<div class="search">
					<input id="search" type="text" placeholder="Recherche">
					<button>
						<i class="fas fa-search special"></i>
					</button>
				</div>
				<table id="q2a" class="table table-hover table-sm table-borderless">
					<thead><tr class="special" ></tr></thead>
					<tbody></tbody>
				</table>
			</div>
			<div id="help" onclick="$('#help-modal').modal('toggle');"></div>
		</section>
		<section id="plan">
			<div class="container">
				<div class="plan">
					<div>
						<h5 class="special"><a href="#publications">Ensemble de publications</a></h5>
						<p>Trouver l'ensemble des publications d'un auteur à partir de son matricule.</p>
					</div>
					<div>
						<h5 class="special"><a href="#new-article">Nouvel article</a></h5>
						<p>Formulaire pour ajouter un article dans la base de données.</p>
					</div>
					<div>
						<h5 class="special"><a href="#authors">Participants actifs</a></h5>
						<p>Les chercheurs qui sont auteurs d'au moins un article à chaque conférence à laquelle ils ont assisté.</p>
					</div>
					<div>
						<h5 class="special"><a href="#subjects">Sujets populaires</a></h5>
						<p>Les sujets les plus étudiés au cours des 5 conférences les plus populaires depuis 2012.</p>
					</div>
				</div>
			</div>
		</section>
		<section id="publications">
			<div class="container">
				<div class="sub-title special">Ensemble de publications</div>
				<div class="input-group input-group-sm mb-3 search_matricule">
					<select class="custom-select" id="matricule">
						<option selected>Choisir...</option>
					</select>
				</div>
				<table id="q2b" class="table table-hover table-sm table-borderless">
					<thead>
						<tr class="special"><th scope="column">Titre</th><th scope="column">Date de publication</th><th scope="column">Type</th><th scope="column">Seconds auteurs</th></tr>
					</thead>
					<tbody></tbody>
				</table>
			</div>
		</section>
		<section id="new-article">
			<div class="container">
				<div class="sub-title special">Nouvel article</div>
				<form>
					<div class="form-group">
						<label>URL</label>
						<input type="url" name="url" class="form-control" placeholder="https://exemple.com/" required>
					</div>
					<div class="form-group">
						<label>DOI</label>
						<input type="number" name="doi" class="form-control" placeholder="314159265" required>
					</div>
					<div class="form-group">
						<label>Titre</label>
						<input type="text" name="titre" class="form-control" placeholder="Le féminisme ou comment cassez les couilles sans les toucher." required>
					</div>
					<div class="form-group">
						<label>Date de publication</label>
						<input type="date" name="date_publication" class="form-control" required>
					</div>
					<div class="form-group">
						<label>Matricule de l'auteur</label>
						<input type="number" name="matricule_auteur" class="form-control" placeholder="42" required>
					</div>
					<div class="custom-control custom-switch">
						<input type="checkbox" class="custom-control-input" id="switch" name="switch">
						<label class="custom-control-label" data-on="Artice de journal" data-off="Artice de conférence">Artice de journal</label>
					</div>
				</form>
			</div>
		</section>
		<section id="authors">
			<div class="container">
				<div class="sub-title special">Participants actifs</div>
				<table id="q2d" class="table table-hover table-sm table-borderless">
					<thead>
						<tr class="special"><th scope="column">Matricule</th><th scope="column">Nom</th><th scope="column">Prénom</th></tr>
					</thead>
					<tbody></tbody>
				</table>
			</div>
		</section>
		<section id="subjects">
			<div class="container">
				<div class="sub-title special">Sujets populaires</div>
				<table id="q2e" class="table table-hover table-sm table-borderless">
					<thead>
						<tr class="special" ><th scope="column">Sujets</th><th scope="column">Citations</th></tr>
					</thead>
					<tbody></tbody>
				</table>
			</div>
		</section>
		<div class="modal fade" id="help-modal" tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-dialog modal-xl">
					 <div class="modal-content">
					<p class="mb-2">Pour trouver un ou plusieurs éléments dans la base de donnée, il suffit d'entrer le nom de la table dans laquelle les rechercher et les contraintes que leurs attributs doivent respecter.</p>
					<p class="mb-2">Il est possible de contraindre à l'égalité pour les attributs numériques (numéro, matricule, année,...) et à la contenance pour les autres.</p>
					<p class="mb-2">Voici les tables de la base de données et leurs attributs :</p>
					<div class="table-responsive-xl">
						<table id="tables" class="table table-hover table-sm table-borderless mb-2">
							<tbody></tbody>
						</table>
					</div>
					<p class="mb-2">Par exemple, pour rechercher les articles dont le titre contient <samp>physique</samp>, la date de publication est <samp>18/03/1999</samp> et le matricule de l'auteur est <samp>13</samp> :</p>
					<div class="special code" style="margin: 0 auto; width: 66%; text-align: center;">
						articles, titre=physique, date_publication=18/03/1999, matricule_auteur=13
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			function isset(e) {
				return typeof(e) != 'undefined' && e !== null;
			}

			function build_html(result) {
				if (!isset(result) || result.length == 0) {
					return '<tr><td style="text-align:center;">Aucun résultat.</td></tr>';
				}
				var html;
				$.each(result, function(key, value) {
					html += '<tr>';
					$.each(value, function(subkey, subvalue) {
						html += '<td>' + subvalue + '</td>';
					});
					html += '</tr>';
				});
				return html;
			}

			var tables;
			
			$.ajax({
				url:"include/scheme.php",
				success:function(result){
					tables = result;
					$.each(tables, function(key, value) {
						$('#tables > tbody').append('<tr table="' + key +'"><th class="special" scope="row">' + key + '</th></tr>');
						$.each(value, function(subkey, subvalue) {
							$('[table='+ key +']').append('<td>' + subvalue + '</td>');
						});
					});
				}
			});

			var auteurs;

			$.ajax({
				type: "GET",
				url:"include/questions/sql.php",
				data: {file: 'authors'},
				success:function(result) {
					auteurs = result;
					$.each(auteurs, function(key, value) {
						$('#matricule').append('<option value="' + value[0] + '">' + value[0] + ' - ' + value[1] + ' ' + value[2] + '</option>');
					});
				}
			});
		</script>
		<script type="text/javascript" name="q2a">
			$('#search + button').click(function() {
				if (isset($('#search').val())) {
					var input = parse($('#search').val());
					if (isset(tables[input['table']])) {
						$('#hero').css('padding-top', '15vh');
						$.ajax({
							type: "GET",
							url:"include/questions/q2a.php",
							data: input,
							success:function(result) {
								var html = '<tr class="special">';
								$.each(result[0], function(key, value) {
									html += '<th scope="column">' + value[0] + '</th>';
								});
								html += '</tr>';
								$('#q2a > thead').html(html);
								$('#q2a > tbody').html(build_html(result[1]));
							}
						});
					}
				}
			});

			function parse(str) {
				var constraints = str.split(',');
				var input = {
					'table': constraints.shift()
				};

				var e, i;
				while (constraints.length > 0) {
					constraint = constraints.shift();
					if (constraint.includes('=')) {
						i = constraint.indexOf('=');
						input[$.trim(constraint.slice(0, i))] = $.trim(constraint.slice(i + 1));
					}
				}

				return input;
			}
		</script>
		<script type="text/javascript" name="q2b">
			$('#matricule').change(function() {
				if (isset($('#matricule').val())) {
					$.ajax({
						type: "GET",
						url:"include/questions/q2b.php",
						data: {matricule: $('#matricule').val()},
						success:function(result) {
							$('#q2b > tbody').html(build_html(result));
						}
					});
				}
			});
		</script>
		<script type="text/javascript" name="q2d">
			$.ajax({
				type: "GET",
				url:"include/questions/sql.php",
				data: {file: 'questions/q2d'},
				success:function(result) {
					$('#q2d > tbody').html(build_html(result));
				}
			});
		</script>
		<script type="text/javascript" name="q2e">
			$.ajax({
				type: "GET",
				url:"include/questions/sql.php",
				data: {file: 'questions/q2e'},
				success:function(result) {
					$('#q2e > tbody').html(build_html(result));
				}
			});
		</script>
	</body>
</html>